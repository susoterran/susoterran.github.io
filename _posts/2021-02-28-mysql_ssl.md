---
title:  "[MySQL/MariaDB] MySQL/MariaDB SSL 적용하기"
excerpt: "MySQL/MariaDB 서버와 클라이언트 간 데이터 전송 구간에 SSL 적용"
header:
  overlay_color: "#333"
  actions:
    - label: "MariaDB 공식사이트"
      url: "https://mariadb.org/"
categories:
  - mysql
tags:
  - MariaDB
  - Linux
  - 서버운영
  - 서버보안
last_modified_at : 2021-02-28
last_modified_at_2 : 2021-02-28
toc: true
toc_label: "목차"
toc_sticky: true
classes: wide
share: false
layout: single
comments: true
---


## 개요

원격지에서 MySQL 서버에 접속했을 시 평문 통신을 하게 된다. 이 경우 서버와 원격지 간의 구간을 오가는 데이터들이 어떠한 보호 조치도 없이 지나다니기 때문에 스니핑이나 MITM과 같은 공격에 노출된다.
	
이를 막기 위해 MySQL (MariaDB도 마찬가지로) 에서는 서버-클라이언트, 마스터-슬레이브 간의 데이터 송수신을 SSL/TLS를 이용한 암호화를 통해 외부에 접속 정보 및 데이터가 노출되지 않도록 막을 수 있다.


## 테스트 환경
- CentOS 7
- OpenSSL 1.1.1i
- MySQL 5.6.48 / MySQL 5.7.32 
- MariaDB 10.4.17

## 버전별 SSL 지원 현황
### MySQL 5.6
- 5.6.5까지 : SSL을 지원하지 않음 (옵션 : no)
- 5.6.6~5.6.45 : mysql 소스에 포함된 SSL 라이브러리를 사용 (옵션 : bundled)
- 5.6.46 ~ : 시스템에 설치되어 있는 (/usr/lib 또는 /usr/lib64 에 설치된) OpenSSL 라이브러리를 이용 (기본 옵션 : system)
- 공식사이트 설명 : <a href="https://dev.mysql.com/doc/refman/5.6/en/source-configuration-options.html#option_cmake_with_ssl">https://dev.mysql.com/doc/refman/5.6/en/source-configuration-options.html#option_cmake_with_ssl</a>


### MySQL 5.7
- ~ 5.7.27 : mysql 소스에 포함된 SSL 라이브러리를 사용 (기본 옵션 : bundled)
- 5.7.28 ~ : 시스템에 설치되어 있는 (/usr/lib 또는 /usr/lib64 에 설치된) OpenSSL 라이브러리를 이용 (기본 옵션 : system)
- 공식사이트 설명 : <a href="https://dev.mysql.com/doc/refman/5.7/en/source-configuration-options.html#option_cmake_with_ssl">https://dev.mysql.com/doc/refman/5.7/en/source-configuration-options.html#option_cmake_with_ssl</a>

### MariaDB 10.2.x 이상

- 기본적으로 시스템에 설치되어 있는 GnuTLS 라이브러리를 이용 
  - 그래서 설치 전 "yum -y install gnutls-devel" 명령어로 라이브러리 설치
	- -DWITH_SSL 의 기본 옵션 : system
- yum으로 openssl-devel과 gnutls-devel이 같이 설치되어있을 경우 openssl-devel을 우선 사용
-	-DWITH_SSL 옵션에 컴파일 설치한 SSL 라이브러리의 경로를 지정하여 MariaDB 설치 가능
  - ex : "-DWITH_SSL=/usr/local/openssl"


## 사설 인증서 생성

MySQL 서버 (또는 마스터 서버)에서 SSL 통신을 하기 위한 사설 인증서를 OpenSSL로 생성한다.

### 인증서 저장 위치 생성
```
[root@localhost work]# mkdir /etc/ssl/mysql
[root@localhost work]# cd /etc/ssl/mysql
```

### 사설 CA 인증서 생성

Common Name 에 'mysql-admin' 입력

```
[root@localhost mysql]# /usr/local/openssl/bin/openssl genrsa 2048 > ca-key.pem
[root@localhost mysql]# /usr/local/openssl/bin/openssl req -new -x509 -nodes -days 365000 -key ca-key.pem -out ca.pem
Common Name (e.g. server FQDN or YOUR name) []:mysql-admin
```

### 서버 인증서 생성

Common Name 에 'mysql-server' 입력

```
[root@localhost mysql]# /usr/local/openssl/bin/openssl req -newkey rsa:2048 -days 365000 -nodes -keyout server-key.pem -out server-req.pem
Common Name (e.g. server FQDN or YOUR name) []:mysql-server
	
[root@localhost mysql]# /usr/local/openssl/bin/openssl rsa -in server-key.pem -out server-key.pem
[root@localhost mysql]# /usr/local/openssl/bin/openssl x509 -req -in server-req.pem -days 365000 -CA ca.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem
	
[root@localhost mysql]# /usr/local/openssl/bin/openssl verify -CAfile ca.pem server-cert.pem 
server-cert.pem: OK

[root@localhost mysql]# ls -al
drwxr-xr-x  2 root root  172  7월 18 11:35 .
drwxr-xr-x. 3 root root   32  7월 18 11:17 ..
-rw-r--r--  1 root root 1675  7월 18 11:26 ca-key.pem
-rw-r--r--  1 root root 1314  7월 18 11:27 ca.pem
-rw-r--r--  1 root root 1168  7월 18 11:27 server-cert.pem
-rw-------  1 root root 1679  7월 18 11:27 server-key.pem
-rw-r--r--  1 root root  993  7월 18 11:27 server-req.pem
```

### 클라이언트 인증서 생성

클라이언트 인증서는 다음과 같은 용도로 사용한다.

  - DB 서버와 별도로 존재하는 웹 서버에서 DB 서버로 SSL 통신을 할 때 웹 서버에 적용
	- 접속하고자 하는 DB 서버와 별도의 리눅스 환경에서 mysql 클라이언트 프로그램으로 DB 서버에 접속할 때 클라이언트에 적용
	- Replication 에서 Master와 Slave 간의 SSL 통신을 하고자 할 때 Slave 서버에 적용

Common Name 에 'mysql-client' 입력

```
[root@localhost mysql]# /usr/local/openssl/bin/openssl req -newkey rsa:2048 -days 365000 -nodes -keyout client-key.pem -out client-req.pem
Common Name (e.g. server FQDN or YOUR name) []:mysql-client
	
[root@localhost mysql]# /usr/local/openssl/bin/openssl rsa -in client-key.pem -out client-key.pem
[root@localhost mysql]# /usr/local/openssl/bin/openssl x509 -req -in client-req.pem -days 365000 -CA ca.pem -CAkey ca-key.pem -set_serial 01 -out client-cert.pem

[root@localhost mysql]# /usr/local/openssl/bin/openssl verify -CAfile ca.pem client-cert.pem 
client-cert.pem: OK

[root@localhost mysql]# ls -al
drwxr-xr-x  2 root root  172  7월 18 11:35 .
drwxr-xr-x. 3 root root   32  7월 18 11:17 ..
-rw-r--r--  1 root root 1675  7월 18 11:26 ca-key.pem
-rw-r--r--  1 root root 1314  7월 18 11:27 ca.pem
-rw-r--r--  1 root root 1176  7월 18 11:35 client-cert.pem
-rw-------  1 root root 1679  7월 18 11:35 client-key.pem
-rw-r--r--  1 root root  997  7월 18 11:31 client-req.pem
-rw-r--r--  1 root root 1168  7월 18 11:27 server-cert.pem
-rw-------  1 root root 1679  7월 18 11:27 server-key.pem
-rw-r--r--  1 root root  993  7월 18 11:27 server-req.pem
```


## 인증서 설정

### 서버 측 설정

인증서 파일과 경로에 mysql 권한 설정

```
[root@localhost mysql]# chown mysql. *
[root@localhost mysql]# ls -al
drwxr-xr-x  2 root  root   172  7월 18 11:35 .
drwxr-xr-x. 3 root  root    32  7월 18 11:17 ..
-rw-r--r--  1 mysql mysql 1675  7월 18 11:26 ca-key.pem
-rw-r--r--  1 mysql mysql 1314  7월 18 11:27 ca.pem
-rw-r--r--  1 mysql mysql 1168  7월 18 11:27 server-cert.pem
-rw-------  1 mysql mysql 1679  7월 18 11:27 server-key.pem
-rw-r--r--  1 mysql mysql  993  7월 18 11:27 server-req.pem
```

my.cnf 에 아래의 내용 추가

```
[root@localhost mysql]# vi /etc/my.cnf
[mysqld]
~
### SSL/TLS
ssl_cert = /etc/ssl/mysql/server-cert.pem
ssl_key = /etc/ssl/mysql/server-key.pem
ssl_ca = /etc/ssl/mysql/ca.pem
```

mysql 서비스 재실행
```
[root@localhost mysql]# systemctl restart mysqld.service 
```

SSL 적용 상태 확인

<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/01_mysql_ssl_config.jpg?raw=true"></center>
<br>
<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/02_mariadb_ssl_config_1.jpg?raw=true"></center>
<br>
<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/03_mariadb_ssl_config_2.jpg?raw=true"></center>
<br>

### 클라이언트 측 설정

해당 내용은 리눅스 환경에서 mysql 클라이언트 프로그램을 이용하여 원격 서버에 접속하는 경우 설정한다.
윈도우 환경에서 mysql 서버로 원격 접속할 경우에는 SSL 인증서 등록이 필요 없다.

테스트 환경
```
서버 환경
- CentOS 7.9
- MariaDB 10.4.17
	
클라이언트 환경
- CentOS 7.9
- MySQL 5.6.48 (클라이언트 프로그램 기준)
```
```
[root@localhost mysql]# ls -al /etc/ssl/mysql/
합계 16
drwxr-xr-x  2 root  root    87  2월  9 14:44 .
drwxr-xr-x. 3 root  root    32  2월  9 14:42 ..
-rw-r--r--  1 mysql mysql 1310  2월  9 14:43 ca.pem
-rw-r--r--  1 mysql mysql 1164  2월  9 14:43 client-cert.pem
-rw-------  1 mysql mysql 1679  2월  9 14:43 client-key.pem
-rw-r--r--  1 mysql mysql  989  2월  9 14:43 client-req.pem
	
[root@localhost mysql]# /usr/local/mysql/bin/mysql -u root -p -h 203.231.238.121 --ssl=TRUE --ssl-ca=/etc/ssl/mysql/ca.pem --ssl-cert=/etc/ssl/mysql/client-cert.pem --ssl-key=/etc/ssl/mysql/client-key.pem
```
<br>
<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/04_mysql_client_ssl.jpg?raw=true"></center>
<br>

## 윈도우 환경에서 SSL로 서버에 접속하기 (HeidiSQL)

### 일반적인 접속 방법
<br>
<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/05_heidi_plaintext_1.jpg?raw=true"></center>
<br>

아래와 같이 MySQL 접속 정보가 평문으로 나온다.

<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/06_heidi_plaintext_2.jpg?raw=true"></center>
<br>

아래와 같이 쿼리를 입력했을 때 해당 쿼리는 물론이거니와 결과값도 평문으로 나온다.

use mysql;

SHOW TABLES;

<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/07_heidi_plaintext_3.jpg?raw=true"></center>
<br>

### SSL 적용

접속 정보에서부터 TLS 1.2로 암호화되는 것을 알 수 있다.

'SSL 사용' 체크 이외에 다른 설정 할 필요 없다.
<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/08_heidi_secured_1.jpg?raw=true"></center>
<br>
<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/09_heidi_secured_2.jpg?raw=true"></center>
<br>

## 특정 계정에 대해 무조건 SSL 접속을 하도록 설정

MySQL 서버 (또는 Replication의 마스터 서버) 에서 아래와 같이 REQUIRE SSL 옵션을 추가한다.

```
MariaDB [mysql]> grant all privileges on *.* to 'root'@'클라이언트IP' identified by 'asdf1234' REQUIRE SSL;
```

Heidi에서 원격 접속 시 'SSL 사용'을 설정하지 않으면 아래와 같이 접속 실패 메시지가 나타난다.

<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/10_required_ssl_1.jpg?raw=true"></center>
<br>

SSL을 통해 접속을 진행한 후 연결 정보를 확인한다.

<center><img src="https://github.com/susoterran/susoterran.github.io/blob/master/assets/img/2021-02-28-mysql_ssl/11_required_ssl_2.jpg?raw=true"></center>
<br>